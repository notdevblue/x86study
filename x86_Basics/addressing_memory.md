# [Addressing memory](https://en.wikibooks.org/wiki/X86_Assembly/16,_32,_and_64_Bits)

## 8086 and 80186

원래의 8086은 16비트 크기의 레지스터만 가지고 있었음. [0 - (2^16 - 1)] 범위 안의 값을 효율적으로 저장할 수 있음. (간단하게 마랗면 65536 가지의 다른 바이트들, 또는 64 kibibytes.)
하지만 주소 버스 (메모리 컨트롤러의 연결 지점, 주소를 받아서 안에 있는 내용을 얻어서 CPU의 데이터 버스에 넘김.) 의 크기는 20비트임. 효율적으로 1 mebibyte 의 메모리를 주소 지정할 수 있음.

이는 모든 레지스터는 혼자서 주소 버스의 전채 넓이를 활용할 수 없다는 의미임. 4 bits 를 사용하지 않고 남겨, 사용 가능한 주소를 16개로 축소함 (1024 KiB / 64 Kib = 16).

<br/>

문제는 이것임: "20비트 주소 공간이 16비트 레지스터에 어떻게 담길 수 있는가?". 이를 해결하기 위해 Intel의 엔지니어들은 세그먼트 레지스터 CS, DS, ES, SS를 떠올림. 20-bit 주소로 변경하기 위해, 먼저 주소를 16으로 나눈 뒤, 몫을 세그먼트 레지스터에 넣고, 나머지를 오프셋 레지스터에 넣음. 이는 CS:IP 로 표현됨. (CS 가 세그먼트이고, IP 가 오프셋이라는 의미) 비슷하게, 주소가 SS:SP 로 써졌다면, SS가 세그먼트고, SP가 오프셋이라는 의미임.

이는 반대 방향에도 적용됨. 변환하는 대신 20비트 주소를 만들기 위해, 세그먼트 레지스터의 16-bit 값을 왼쪽으로 4번 밀고 (shift 4 times, addr << 4) 주소 버스에 넣음. 그리고 다른 레지스터에 존재하는 오프셋을 그냥 버스에 넣으면 20비트 주소가 만들어짐.

### Example

CS = 258C, IP = 0012(16진수) 인 경우, CS:IP 는 "CS x 16 + IP" 와 같은 20비트 주소를 가리킴. 이는 이와 같음.

> 258C x 10(16진수) + 0012(16진수) = 258C0 + 0012(16진수) = 258D2

20비트 주소는 absolute (or linear) address 라고도 불리고, Segment:Offset 표현(CS:IP)은 Segmented address 라고도 불림.
이 분리는 레지스터가 16비트 인코딩보다 큰 값을 가질 수 없기에 필요했음.

32-bit 또는 64-bit 프로세서에서 Protected Mode 를 이용해 프로그래밍 할 때는, 레지스터가 주소 버스 전부를 담기을 수 있는 크기를 가짐, 따라서 세그멘티드 주소를 없엠. 오직 linear/logical 주소만 이 "flat addressing" 모드에서 사용됨. 하지만 Segment:Offset 구조는 여전히 호환성을 위해 지원됨.

<br/>

물리 주소와 세그먼티드 주소는 1 대 1 대입이 아니라는걸 알아야 함. 물리 주소 하나에는 하나 이상의 세그먼트 주소가 존재함.
예를 들어 세그먼트 표현인 B000:8000 과 B200:6000 을 생각해보면, 둘다 물리 주소 B8000 으로 계산됨.

> B000:8000 = B000 x 10(16진수) + 8000(16진수)  = B0000 + 8000(16진수) = B8000 <br/>
> B200:6000 = B200 x 10(16진수) + 6000(16진수)  = B2000 + 6000(16진수) = B8000

하지만, 적절한 매핑 방식을 사용하면 위와 같은 문제를 피할 수 있음. 이러한 매핑 방식은 물리 주소를 선형 변환하여서 하나의 고유한 세그먼트된 주소를 만듬. 이 변환을 다시 되돌리려면, 매핑 방식 [f(x)] 는 단순히 반전됨.

예를 들어, 세그먼트 부분이 물리 주소를 10(16진수) 로 나눈 것과 같다면, 오프셋은 그의 나머지와 같음, 오직 하나의 세그먼트된 주소가 생성됨. (오프셋은 0F보다 크지 않음) 물리 주소 B8000은 (B800 / 10(16진수)):(B8000 mod 10(16진수)) 또는 B800:0 으로 매핑됨. 이 세그먼트 표현은 특별한 이름이 있음. 이러한 주소는 "normalized Address"(정규화된 주소) 라고 불림.

<br/>

CS:IP (Code Segment: Instruction Pointer) 는 다음에 실행 명령이 있는 20-bit 의 물리 메모리 주소를 나타냄.
이와 같이 SS:SP (Stack Segment: Stack Pointer) 는 스택의 맨 위 20-bit 절대 주소를 가리킴. (8086은 이를 값 push/pop 하는데 사용함)

## Protected Mode (80286+)

## 32-Bit Addressing
